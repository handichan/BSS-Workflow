# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector=="res") %>% select(in.state,month,year,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="BSS", year==y),
aes(x=month,y=kwh,linetype=s,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste("Residential",y))
eia_ratios_sector
bss_ratios_sector
bss_ratios
state_monthly
optim_float
eia_ratios_sector
optim_float %>% group_by(in.state,sector,kind,season) %>%
summarize(monthly_max=max(state_monthly_kwh)) %>%
pivot_wider(names_from=season,values_from=monthly_max) %>%
mutate(max_winter_to_max_summer=Winter/Summer) %>%
arrange(max_winter_to_max_summer)
bss_ratios_comp<-bss_ratios %>% mutate(adj="raw") %>%
bind_rows(optim_float %>% group_by(in.state,sector,kind,season) %>%
summarize(monthly_max=max(state_monthly_kwh)) %>%
pivot_wider(names_from=season,values_from=monthly_max) %>%
mutate(max_winter_to_max_summer=Winter/Summer) %>%
arrange(max_winter_to_max_summer) %>%
mutate(adj="post calibration"))
eia_ratios_sector %>%  filter(year<2024,sector %in% c("res","com")) %>%
ggplot(aes(x=in.state,y=max_winter_to_max_summer_gross))+
geom_hline(yintercept = 1,color="grey30")+
geom_boxplot()+
geom_point(data=bss_ratios_comp , aes(y=max_winter_to_max_summer,color=adj))+
scale_x_discrete(limits=ratio_breaks$in.state,name="")+
ylab("winter max / summer max")+
facet_wrap(~sector,nrow=2)+
ggtitle("Ratio of max monthly electricity consumption in the winter max to max monthly electricity consumption in the summer",subtitle = "EIA 861 gross 2018-2023 (boxplot) vs. BSS 2020 baseline and adjusted (dots)")
results_floating
#for com
for (st in c(state.abb[!(state.abb %in% c("AK","HI"))],"DC")) {
# Define the data
measured_data <- (eia_gross %>% filter(in.state==st,year==2020,sector=="com"))$gross.kWh  # Monthly measured electricity
sum_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="com",season=="Summer") %>% arrange(desc(gross.kWh)))[1,]$month
win_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="com",season=="Winter") %>% arrange(desc(gross.kWh)))[1,]$month
modeled_heating <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Heating (Equip.)",sector=="com"))$state_monthly_kwh  # Monthly modeled heating
modeled_cooling <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Cooling (Equip.)",sector=="com"))$state_monthly_kwh  # Monthly modeled cooling
modeled_base <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",!(end_use %in% c("Heating (Equip.)","Cooling (Equip.)")),sector=="com") %>%
group_by(month) %>% summarize(non=sum(state_monthly_kwh)))$non     # Monthly modeled base electricity
# Calculate constants
annual_total_modeled <- sum(modeled_heating + modeled_cooling + modeled_base)
winter_max_measured <- measured_data[win_month] #max(measured_data[c(1:2,11:12)])
summer_max_measured <- measured_data[sum_month] #max(measured_data[5:9])
winter_summer_ratio_measured <- winter_max_measured / summer_max_measured
# Run the optimization
result <- optim(
par = initial_guess,
fn = objective_with_constraints_floating,
method = "L-BFGS-B", # Bounded optimization
lower = c(-1, -1, -1), # Lower bounds for multipliers (set as appropriate)
upper = c(20, 20, 20)        # Upper bounds for multipliers (set as appropriate)
)
# Extract results
multipliers <- result$par
names(multipliers) <- c("m_heat", "m_cool", "m_base")
multipliers
results_floating<-bind_rows(results_floating,c(in.state=st,multipliers))
rm(st)
}
st
measured_data <- (eia_gross %>% filter(in.state==st,year==2020,sector=="com"))$gross.kWh  # Monthly measured electricity
measured_data
sum_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="com",season=="Summer") %>% arrange(desc(gross.kWh)))[1,]$month
sum_month
win_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="com",season=="Winter") %>% arrange(desc(gross.kWh)))[1,]$month
win_month
modeled_heating <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Heating (Equip.)",sector=="com"))$state_monthly_kwh  # Monthly modeled heating
modeled_heating
modeled_cooling <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Cooling (Equip.)",sector=="com"))$state_monthly_kwh  # Monthly modeled cooling
modeled_cooling
modeled_base <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",!(end_use %in% c("Heating (Equip.)","Cooling (Equip.)")),sector=="com") %>%
group_by(month) %>% summarize(non=sum(state_monthly_kwh)))$non     # Monthly modeled base electricity
modeled_base
# Calculate constants
annual_total_modeled <- sum(modeled_heating + modeled_cooling + modeled_base)
annual_total_modeled
winter_max_measured <- measured_data[win_month] #max(measured_data[c(1:2,11:12)])
winter_max_measured
summer_max_measured <- measured_data[sum_month] #max(measured_data[5:9])
summer_max_measured
winter_summer_ratio_measured <- winter_max_measured / summer_max_measured
winter_summer_ratio_measured
result <- optim(
par = initial_guess,
fn = objective_with_constraints_floating,
method = "L-BFGS-B", # Bounded optimization
lower = c(-1, -1, -1), # Lower bounds for multipliers (set as appropriate)
upper = c(20, 20, 20)        # Upper bounds for multipliers (set as appropriate)
)
result
multipliers <- result$par
multipliers
names(multipliers) <- c("m_heat", "m_cool", "m_base")
multipliers
results_floating_com<-data.frame()
#for com
for (st in c(state.abb[!(state.abb %in% c("AK","HI"))],"DC")) {
print(st)
# Define the data
measured_data <- (eia_gross %>% filter(in.state==st,year==2020,sector=="com"))$gross.kWh  # Monthly measured electricity
sum_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="com",season=="Summer") %>% arrange(desc(gross.kWh)))[1,]$month
win_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="com",season=="Winter") %>% arrange(desc(gross.kWh)))[1,]$month
modeled_heating <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Heating (Equip.)",sector=="com"))$state_monthly_kwh  # Monthly modeled heating
modeled_cooling <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Cooling (Equip.)",sector=="com"))$state_monthly_kwh  # Monthly modeled cooling
modeled_base <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",!(end_use %in% c("Heating (Equip.)","Cooling (Equip.)")),sector=="com") %>%
group_by(month) %>% summarize(non=sum(state_monthly_kwh)))$non     # Monthly modeled base electricity
# Calculate constants
annual_total_modeled <- sum(modeled_heating + modeled_cooling + modeled_base)
winter_max_measured <- measured_data[win_month] #max(measured_data[c(1:2,11:12)])
summer_max_measured <- measured_data[sum_month] #max(measured_data[5:9])
winter_summer_ratio_measured <- winter_max_measured / summer_max_measured
# Run the optimization
result <- optim(
par = initial_guess,
fn = objective_with_constraints_floating,
method = "L-BFGS-B", # Bounded optimization
lower = c(-1, -1, -1), # Lower bounds for multipliers (set as appropriate)
upper = c(20, 20, 20)        # Upper bounds for multipliers (set as appropriate)
)
# Extract results
multipliers <- result$par
names(multipliers) <- c("m_heat", "m_cool", "m_base")
multipliers
results_floating_com<-bind_rows(results_floating_com,c(in.state=st,multipliers))
rm(st)
}
results_floating_com
results_floating_com<-results_floating_com %>% mutate(m_heat=as.numeric(m_heat),m_cool=as.numeric(m_cool),m_base=as.numeric(m_base),sector="com")
results_floating_res<-data.frame()
for (st in c(state.abb[!(state.abb %in% c("AK","HI"))],"DC")) {
# Define the data
measured_data <- (eia_gross %>% filter(in.state==st,year==2020,sector=="res"))$gross.kWh  # Monthly measured electricity
sum_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="res",season=="Summer") %>% arrange(desc(gross.kWh)))[1,]$month
win_month<- (eia_gross %>% filter(in.state==st,year==2020,sector=="res",season=="Winter") %>% arrange(desc(gross.kWh)))[1,]$month
modeled_heating <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Heating (Equip.)",sector=="res"))$state_monthly_kwh  # Monthly modeled heating
modeled_cooling <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",end_use=="Cooling (Equip.)",sector=="res"))$state_monthly_kwh  # Monthly modeled cooling
modeled_base <- (state_monthly %>% filter(in.state==st,kind=="gap model; com other",!(end_use %in% c("Heating (Equip.)","Cooling (Equip.)")),sector=="res") %>%
group_by(month) %>% summarize(non=sum(state_monthly_kwh)))$non     # Monthly modeled base electricity
# Calculate constants
annual_total_modeled <- sum(modeled_heating + modeled_cooling + modeled_base)
winter_max_measured <- measured_data[win_month] #max(measured_data[c(1:2,11:12)])
summer_max_measured <- measured_data[sum_month] #max(measured_data[5:9])
winter_summer_ratio_measured <- winter_max_measured / summer_max_measured
# Run the optimization
result <- optim(
par = initial_guess,
fn = objective_with_constraints_floating,
method = "L-BFGS-B", # Bounded optimization
lower = c(-1, -1, -1), # Lower bounds for multipliers (set as appropriate)
upper = c(20, 20, 20)        # Upper bounds for multipliers (set as appropriate)
)
# Extract results
multipliers <- result$par
names(multipliers) <- c("m_heat", "m_cool", "m_base")
multipliers
results_floating_res<-bind_rows(results_floating_res,c(in.state=st,multipliers))
rm(st)
}
results_floating_res<-results_floating_res %>% mutate(m_heat=as.numeric(m_heat),m_cool=as.numeric(m_cool),m_base=as.numeric(m_base),sector="res")
#state monthly end use with the multipliers applied
optim_float <- state_monthly %>% filter(kind=="gap model; com other") %>%
full_join(bind_rows(results_floating_res,results_floating_com),by=c("in.state","sector")) %>%
mutate(monthly_adj=case_when(end_use == "Heating (Equip.)" ~ m_heat * state_monthly_kwh,
end_use == "Cooling (Equip.)" ~ m_cool * state_monthly_kwh,
TRUE ~ m_base * state_monthly_kwh),
s="BSS gap model; com other",kind="bss")
optim_float
summary(optim_float)
bss_ratios_comp<-bss_ratios %>% mutate(adj="raw") %>%
bind_rows(optim_float %>% group_by(in.state,sector,kind,season) %>%
summarize(monthly_max=max(state_monthly_kwh)) %>%
pivot_wider(names_from=season,values_from=monthly_max) %>%
mutate(max_winter_to_max_summer=Winter/Summer) %>%
arrange(max_winter_to_max_summer) %>%
mutate(adj="post calibration"))
eia_ratios_sector %>%  filter(year<2024,sector %in% c("res","com")) %>%
ggplot(aes(x=in.state,y=max_winter_to_max_summer_gross))+
geom_hline(yintercept = 1,color="grey30")+
geom_boxplot()+
geom_point(data=bss_ratios_comp , aes(y=max_winter_to_max_summer,color=adj))+
scale_x_discrete(limits=ratio_breaks$in.state,name="")+
ylab("winter max / summer max")+
facet_wrap(~sector,nrow=2)+
ggtitle("Ratio of max monthly electricity consumption in the winter max to max monthly electricity consumption in the summer",subtitle = "EIA 861 gross 2018-2023 (boxplot) vs. BSS 2020 baseline and adjusted (dots)")
bss_ratios_comp<-bss_ratios %>% mutate(adj="raw") %>% filter(kind=="gap model; com other") %>%
bind_rows(optim_float %>% group_by(in.state,sector,kind,season) %>%
summarize(monthly_max=max(state_monthly_kwh)) %>%
pivot_wider(names_from=season,values_from=monthly_max) %>%
mutate(max_winter_to_max_summer=Winter/Summer) %>%
arrange(max_winter_to_max_summer) %>%
mutate(adj="post calibration"))
eia_ratios_sector %>%  filter(year<2024,sector %in% c("res","com")) %>%
ggplot(aes(x=in.state,y=max_winter_to_max_summer_gross))+
geom_hline(yintercept = 1,color="grey30")+
geom_boxplot()+
geom_point(data=bss_ratios_comp , aes(y=max_winter_to_max_summer,color=adj))+
scale_x_discrete(limits=ratio_breaks$in.state,name="")+
ylab("winter max / summer max")+
facet_wrap(~sector,nrow=2)+
ggtitle("Ratio of max monthly electricity consumption in the winter max to max monthly electricity consumption in the summer",subtitle = "EIA 861 gross 2018-2023 (boxplot) vs. BSS 2020 baseline and adjusted (dots)")
optim_float %>% filter(in.state=="CA")
optim_float %>% filter(in.state=="CA",end_use=="Cooking")
optim_float
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>% filter(sector=="res",s=="BSS gap model; com other") %>% mutate(year=2020) %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector=="res") %>% select(in.state,month,year,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>%  mutate(year=2020) %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
sec<-"res"
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,linetype=s,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>%  mutate(year=2020) %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,sector,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,linetype=s,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
sec<-"com"
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,linetype=s,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
bss_monthly
optim_float %>%  mutate(year=2020) %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T))
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
bss_monthly %>% mutate(year=2020,kind="bss",s="uncalibrated gap model; com other") %>% select(in.state,month,year,sector,kwh=state_monthly_kwh),
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>%  mutate(year=2020,s="calibrated gap model; com other") %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,sector,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
bss_monthly %>% ungroup()%>% mutate(year=2020,kind="bss",s="uncalibrated gap model; com other") %>% select(in.state,month,year,sector,kwh=state_monthly_kwh),
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>%  mutate(year=2020,s="calibrated gap model; com other") %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,sector,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,linetype=s,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
monthly_magnitudes_adj %>% filter(s=="uncalibrated gap model; com other")
bss_monthly %>% ungroup()%>% mutate(year=2020,kind="bss",s="uncalibrated gap model; com other") %>% select(in.state,month,year,sector,kwh=state_monthly_kwh)
monthly_magnitudes_adj
optim_float %>%  mutate(year=2020,s="calibrated gap model; com other") %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T))
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,sector,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
bss_monthly %>% ungroup()%>% mutate(year=2020,kind="bss",s="uncalibrated gap model; com other") %>% select(in.state,month,year,sector,kwh=state_monthly_kwh),
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>%  mutate(year=2020,s="calibrated gap model; com other") %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,sector,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
monthly_magnitudes_adj %>% filter(s=="uncalibrated gap model; com other")
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
bss_monthly %>% ungroup()%>% mutate(year=2020,kind="bss",s="uncalibrated gap model; com other") %>% select(in.state,month,year,sector,s,kwh=state_monthly_kwh),
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>%  mutate(year=2020,s="calibrated gap model; com other") %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,sector,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,linetype=s,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
monthly_magnitudes_adj %>% filter(s=="uncalibrated gap model; com other")
#combine monthly state-level data sources
monthly_magnitudes_adj<-bind_rows(
bss_monthly %>% ungroup()%>% mutate(year=2020,kind="bss",s="uncalibrated gap model; com other") %>% select(in.state,month,year,sector,kind,s,kwh=state_monthly_kwh),
# rs_monthly %>% mutate(s="ResStock 2024.2",year=2018,kind="comparison") %>% rename(in.state=state),
optim_float %>%  mutate(year=2020,s="calibrated gap model; com other") %>% group_by(in.state,month,year,s,kind,sector) %>% summarize(kwh=sum(monthly_adj,na.rm = T)),
# smeu_adj_flat %>% filter(sector=="res") %>% group_by(in.state,month,s,kind,year) %>% summarize(kwh=sum(state_monthly_kwh)),
# smeu_adj_magnitude  %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_flat %>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_ratio_eia_flat%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_optim_float%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
# smeu_adj_share%>% filter(sector=="res") %>% group_by(in.state,month,year,s,kind) %>% summarize(kwh=sum(monthly_adj)),
eia_gross %>% filter(sector %in% c("res","com")) %>% select(in.state,month,year,sector,kwh=gross.kWh) %>% mutate(s="EIA 861",kind="comparison")
)
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,linetype=s,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
sec<-"res"
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
bss_ratios_comp<-bss_ratios %>% mutate(adj="uncalibrated") %>% filter(kind=="gap model; com other") %>%
bind_rows(optim_float %>% group_by(in.state,sector,kind,season) %>%
summarize(monthly_max=max(state_monthly_kwh)) %>%
pivot_wider(names_from=season,values_from=monthly_max) %>%
mutate(max_winter_to_max_summer=Winter/Summer) %>%
arrange(max_winter_to_max_summer) %>%
mutate(adj="calibrated"))
eia_ratios_sector %>%  filter(year<2024,sector %in% c("res","com")) %>%
ggplot(aes(x=in.state,y=max_winter_to_max_summer_gross))+
geom_hline(yintercept = 1,color="grey30")+
geom_boxplot()+
geom_point(data=bss_ratios_comp , aes(y=max_winter_to_max_summer,color=adj))+
scale_x_discrete(limits=ratio_breaks$in.state,name="")+
ylab("winter max / summer max")+
facet_wrap(~sector,nrow=2)+
ggtitle("Ratio of max monthly electricity consumption in the winter max to max monthly electricity consumption in the summer",subtitle = "EIA 861 gross 2018-2023 (boxplot) vs. BSS 2020 baseline and adjusted (dots)")
sec<-"com"
monthly_magnitudes_adj %>%
filter(kind=="comparison",year==y,sector==sec) %>%
filter(!(in.state %in% c("AK","HI"))) %>%
# filter(in.state %in% state.abb[1:10]) %>%
ggplot(aes(x=month,y=kwh))+
geom_bar(stat="identity",position="dodge",aes(fill=paste(s,year)))+
geom_line(data=monthly_magnitudes_adj %>%
# filter(in.state %in% state.abb[1:10]) %>%
filter(kind=="bss", year==y,sector==sec),
aes(x=month,y=kwh,color=s))+
facet_wrap(~in.state,scales="free")+
scale_color_brewer(name="",palette = "Dark2")+
scale_fill_manual(name="",values="gray70")+
scale_linetype_discrete(name="")+
scale_x_continuous(name="",breaks=c(3,6,9,12),expand=expansion(add=0,mult=c(0.01,.01)))+
scale_y_continuous(name="kWh",expand=expansion(add=0,mult=c(0,.05)))+
ggtitle(paste(sec,y))
